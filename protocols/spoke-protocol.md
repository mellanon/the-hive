# Spoke Protocol

> **Status:** Draft
> **Source:** [pai-collab Issue #80](https://github.com/mellanon/pai-collab/issues/80)

## Purpose

The spoke protocol defines how an operator projects their local state to a hub without coupling local internals to the network. It's the contract between an operator's private workspace and the shared coordination surface.

## Design Principles

1. **Projection, not exposure** — The spoke publishes a curated view. The hub never reaches into local state.
2. **Two files** — manifest (human-maintained identity) + status (auto-generated snapshot). Minimal surface area.
3. **Generic** — The protocol works with any hub, not just pai-collab. A spoke can project to multiple hives.
4. **Lightweight** — YAML files in `.collab/` at the repo root. No infrastructure required.

## Contract

### manifest.yaml (human-maintained)

The stable identity of the spoke. Changes rarely.

```yaml
schemaVersion: "1.0"
name: <project-name>
hub: <org/repo>
project: <project-id>
maintainer: <github-handle>
license: MIT | Apache-2.0 | BSD-2-Clause | BSD-3-Clause
status:
  test: <test command>
  healthCheck: <health check command>
```

### status.yaml (auto-generated)

A point-in-time snapshot of spoke state. Generated by CLI or CI.

```yaml
schemaVersion: "1.0"
generatedAt: <ISO 8601>
generatedBy: <tool + version>

phase: <specify | build | harden | contrib-prep | review | shipped | evolving>
tests:
  passing: <int>
  failing: <int>
git:
  branch: <string>
  lastCommit: <ISO 8601 date>
  dirty: <boolean>
  behindRemote: <int>
```

## CLI Commands

### Spoke-side

| Command | Description |
|---------|-------------|
| `blackboard init` | Create `.collab/` with manifest template + GitHub Action |
| `blackboard status` | Generate status.yaml from current repo state |
| `blackboard validate` | Validate manifest + status against schema |

### Hub-side

| Command | Description |
|---------|-------------|
| `blackboard pull` | Aggregate status from all registered spokes |
| `blackboard registry` | List registered spokes and their health |

## Security Considerations

From [Steffen's security review](https://github.com/mellanon/pai-collab/issues/80):

- **Command injection:** manifest.yaml `status.test` field must be whitelisted, not executed directly
- **Supply chain:** GitHub Actions must pin dependencies with integrity hashes
- **Metadata exposure:** `git.dirty` and `git.behindRemote` expose operational state — consider hashing instead of exposing raw values

## Open Questions

1. How does a spoke register with a hub? (Currently manual REGISTRY.md entry)
2. How frequently should status.yaml be regenerated? (CI on push? Scheduled?)
3. Should status.yaml include local blackboard summary data? (Agent count, work item count)
4. Multi-hub: can one spoke project to multiple hives simultaneously?
